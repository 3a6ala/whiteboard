///////////////////////////////////////////////////////////////////////////
/////////////////////////// Network Manager ///////////////////////////////
///////////////////////////////////////////////////////////////////////////
var NetworkManager={};NetworkManager.socket=null;NetworkManager.objects=new Array;NetworkManager.giveID=0;NetworkManager.connect=function(e){if("WebSocket"in window)NetworkManager.socket=new WebSocket(e);else{if(!("MozWebSocket"in window))return;NetworkManager.socket=new MozWebSocket(e)}NetworkManager.socket.onopen=function(){document.getElementById("chatBox").onkeydown=function(e){if(e.keyCode==13){var t=document.getElementById("chatBox").value;NetworkManager.sendMessage({type:"chat",text:t});document.getElementById("chatBox").value=""}}};NetworkManager.socket.onclose=function(){document.getElementById("chatBox").onkeydown=null};NetworkManager.processMessage=function(e){if(e.type=="chat"){var t="";e.username==="server"?t="<span class='server'>"+e.text+"</span><hr>":t="<span class='user'>"+e.username+" says:</span> "+e.text+"<hr>";var n=document.getElementById("chatText").innerHTML,r=document.getElementById("chatText");r.innerHTML=n+t;r.scrollTop=r.scrollHeight}else if(e.type=="todoItemCreated"){if(NetworkManager.objects.length<e.id||NetworkManager.objects[e.id]==null){var i=new todoItem(workflowCanvas,todoManager,e.xpos,e.ypos,e.content,!1);NetworkManager.objects[e.id]=i;i.id=e.id;e.id>=NetworkManager.giveID&&(NetworkManager.giveID=e.id+1);e.state==="done"&&i.ignoreNetworkToggleDone()}}else if(e.type=="minID")NetworkManager.giveID=e.minID;else if(e.type=="itemMoved")NetworkManager.objects[e.id].setPos(e.xpos,e.ypos);else if(e.type=="itemEdited")NetworkManager.objects[e.id].ignoreNetworkSetText(e.content);else if(e.type=="itemDeleted")NetworkManager.objects[e.id]!=null&&NetworkManager.objects[e.id].onDelete();else if(e.type=="todoItemsDependencyLinked"){var s=new todoLink(workflowCanvas);s.upperItem=NetworkManager.objects[e.upper];s.lowerItem=NetworkManager.objects[e.lower];if(s.upperItem&&s.lowerItem){s.upperItem.addLowerLink(s);s.lowerItem.addUpperLink(s);workflowCanvas.draw()}}else if(e.type=="todoItemsDependencyRemoved"){var o=NetworkManager.objects[e.upper];for(var u=0;u<o.lowerLinks.length;u++)o.lowerLinks[u].lowerItem==NetworkManager.objects[e.lower]&&o.lowerLinks[u].onDelete(!0)}else e.type=="todoItemDone"?NetworkManager.objects[e.id].done||NetworkManager.objects[e.id].ignoreNetworkToggleDone():e.type=="todoItemUndone"?NetworkManager.objects[e.id].done&&NetworkManager.objects[e.id].ignoreNetworkToggleDone():e.type=="sizeToContent"&&NetworkManager.objects[e.id].canvas.sizeToContent()};NetworkManager.socket.onmessage=function(e){var t=JSON.parse(e.data);if(t.type=="update")for(var n=0;n<t.update.length;n++){"type"in t.update[n]&&t.update[n].type=="todoItemCreated"&&NetworkManager.processMessage(t.update[n]);"type"in t.update[n]&&t.update[n].type!="todoItemCreated"&&NetworkManager.processMessage(t.update[n])}else NetworkManager.processMessage(t)}};NetworkManager.initialize=function(){window.location.protocol=="http:"?NetworkManager.connect("ws://"+window.location.host+"/chat"+window.location.search):NetworkManager.connect("wss://"+window.location.host+"/chat"+window.location.search)};NetworkManager.sendMessage=function(e){e!=null&&NetworkManager.socket.send(JSON.stringify(e))};NetworkManager.todoItemCreated=function(e,t,n,r){var i=NetworkManager.giveID;NetworkManager.objects[i]=e;NetworkManager.giveID++;NetworkManager.sendMessage({type:"todoItemCreated",id:i,content:t,xpos:n,ypos:r});return i};NetworkManager.itemMoved=function(e,t,n){NetworkManager.sendMessage({type:"itemMoved",id:e,xpos:t,ypos:n})};NetworkManager.itemEdited=function(e,t){NetworkManager.sendMessage({type:"itemEdited",id:e,content:t})};NetworkManager.itemDeleted=function(e){NetworkManager.sendMessage({type:"itemDeleted",id:e})};NetworkManager.todoItemDependencyLinked=function(e,t){NetworkManager.sendMessage({type:"todoItemsDependencyLinked",upper:e,lower:t})};NetworkManager.todoItemDependencyRemoved=function(e,t){NetworkManager.sendMessage({type:"todoItemsDependencyRemoved",upper:e,lower:t})};NetworkManager.todoItemDone=function(e){NetworkManager.sendMessage({type:"todoItemDone",id:e})};NetworkManager.todoItemUndone=function(e){NetworkManager.sendMessage({type:"todoItemUndone",id:e})};NetworkManager.sizeToContent=function(e){NetworkManager.sendMessage({type:"sizeToContent",id:e})};NetworkManager.initialize();