///////////////////////////////////////////////////////////////////////////
///////////////////////////// Todo List Nodes /////////////////////////////
///////////////////////////////////////////////////////////////////////////
function todoItem(e,t,n,r,i,s){s&&(this.id=NetworkManager.todoItemCreated(this,i,n,r));this.canvas=e;this.todoManager=t;this.pos=new point(n,r);this.text=i;this.editable=!0;this.draggable=!0;this.done=!1;this.canDo=!0;this.div=document.createElement("div");this.div.style.position="absolute";this.div.style.left=this.pos.x+"px";this.div.style.top=this.pos.y+"px";this.div.className="todoItemBox";this.upperButton=document.createElement("div");this.upperButton.className="todoItemTop";this.div.appendChild(this.upperButton);this.textBox=document.createElement("div");this.textBox.className="todoItemContent";this.textBox.innerHTML=this.text;this.div.appendChild(this.textBox);this.doneButton=document.createElement("button");this.doneButton.className="todoItemDone";this.div.appendChild(this.doneButton);this.deleteButton=document.createElement("button");this.deleteButton.className="todoItemDelete";this.div.appendChild(this.deleteButton);this.lowerButton=document.createElement("div");this.lowerButton.className="todoItemBottom";this.div.appendChild(this.lowerButton);e.canvasElm.parentNode.appendChild(this.div);e.renderObjects.push(this);t.todoItems.push(this);t.updateList();this.lowerRight=new point(this.pos.x+this.div.offsetWidth,this.pos.y+this.div.offsetHeight);e.stretchToContent(this.lowerRight.x,this.lowerRight.y);e.draw();this.upperLinks=new Array;this.lowerLinks=new Array;var o,u=this;this.onDelete=function(n){var r=e.renderObjects.indexOf(u);if(r!=-1){if(!window.confirm("Really delete?"))return;e.renderObjects.splice(r,1)}r=t.todoItems.indexOf(u);r!=-1&&t.todoItems.splice(r,1);try{e.canvasElm.parentNode.removeChild(u.div)}catch(i){}for(var s=0;s<u.upperLinks.length;s++)u.upperLinks[s].onDelete();for(var s=0;s<u.lowerLinks.length;s++)u.lowerLinks[s].onDelete();u.lowerRight.x=0;u.lowerRight.y=0;e.draw();t.updateList();u.upperButton.removeEventListener("mouseover",u.upperButtonMouseOver);u.upperButton.removeEventListener("mouseout",u.upperButtonMouseOut);u.upperButton.removeEventListener("mousedown",u.upperButtonMouseDown);u.lowerButton.removeEventListener("mouseover",u.lowerButtonMouseOver);u.lowerButton.removeEventListener("mouseout",u.lowerButtonMouseOut);u.lowerButton.removeEventListener("mousedown",u.lowerButtonMouseDown);u.div.removeEventListener("mouseover",u.mainMouseOver);u.div.removeEventListener("mouseout",u.mainMouseOut);window.removeEventListener("mouseup",u.generalMouseUp);window.removeEventListener("mousemove",u.generalMouseMoved);u.cleanupEditable();u.cleanupDraggable();n&&NetworkManager.itemDeleted(u.id)};this.deleteButton.onclick=this.onDelete;this.updateLinks=function(){for(var e=0;e<u.upperLinks.length;e++)u.upperLinks[e].updateLine();for(var e=0;e<u.lowerLinks.length;e++)u.lowerLinks[e].updateLine()};this.setPos=function(e,t){u.pos.x=e;u.pos.y=t;u.div.style.left=e+"px";u.div.style.top=t+"px";u.doneButton.style.top==="-30px"?u.doneButton.style.top="-31px":u.doneButton.style.top="-30px";u.deleteButton.style.top==="-30px"?u.deleteButton.style.top="-31px":u.deleteButton.style.top="-30px";u.updateLinks();u.lowerRight.x=e+u.div.offsetWidth;u.lowerRight.y=t+u.div.offsetHeight;u.canvas.stretchToContent(u.lowerRight.x,u.lowerRight.y);u.canvas.draw()};this.ignoreNetworkSetText=function(e){u.text=e;u.textBox.innerHTML=e;u.todoManager.updateList();u.textBox.text=e;u.updateLinks();u.canvas.draw()};this.setText=function(e){u.ignoreNetworkSetText(e);NetworkManager.itemEdited(u.id,u.textBox.text)};this.onEditStateChange=function(e){u.draggable=!e;if(!e){u.text=u.textBox.innerHTML;u.todoManager.updateList();NetworkManager.itemEdited(u.id,u.textBox.text)}u.updateLinks();u.canvas.draw()};this.ignoreNetworkToggleDone=function(){u.done=!u.done;u.done&&(u.doneButton.style.display="none");for(var e=0;e<u.lowerLinks.length;e++)!u.done&&u.lowerLinks[e].lowerItem.done?u.lowerLinks[e].onDelete():u.lowerLinks[e].lowerItem.onUpperLinkDone();u.todoManager.updateList()};this.toggleDone=function(){u.ignoreNetworkToggleDone();if(u.done){NetworkManager.todoItemDone(u.id);u.div.className="todoItemBox done"}else NetworkManager.todoItemUndone(u.id)};this.setCanDo=function(e){if(!u.done){u.canDo=e;u.doneButton.style.display=u.canDo?"":"none";u.todoManager.updateList();u.updateLinks();u.canvas.draw();u.div.className="todoItemBox"+(u.canDo?"":" cant")}};this.updateCanDo=function(){var e=!0;for(var t=0;t<u.upperLinks.length;t++)if(!u.upperLinks[t].upperItem.done){e=!1;break}u.setCanDo(e)};this.doneButton.onclick=this.toggleDone;this.addUpperLink=function(e){u.upperLinks.push(e);e.upperItem.done||(u.done?e.onDelete():u.setCanDo(!1))};this.addLowerLink=function(e){u.lowerLinks.push(e)};this.onUpperLinkDone=function(){u.updateCanDo()};this.onUpperLinkUndone=function(){u.setCanDo(!1)};this.removeUpperLink=function(e){var t=u.upperLinks.indexOf(e);t!=-1&&u.upperLinks.splice(t,1);u.updateCanDo()};this.removeLowerLink=function(e){var t=u.lowerLinks.indexOf(e);t!=-1&&u.lowerLinks.splice(t,1)};this.upperButtonMouseOver=function(e){u.draggable=!1};this.upperButtonMouseOut=function(e){u.draggable=!0};this.lowerButtonMouseOver=function(e){u.draggable=!1};this.lowerButtonMouseOut=function(e){u.draggable=!0};this.mainMouseOver=function(){u.canvas.currentlyDraggingObject&&u.canvas.currentlyDraggingObject!=u&&u.canvas.currentlyDraggingObject.passedOverButton&&u.canvas.currentlyDraggingObject.passedOverButton(u,!0)};this.mainMouseOut=function(){u.canvas.currentlyDraggingObject&&u.canvas.currentlyDraggingObject!=u&&u.canvas.currentlyDraggingObject.passedOutOfButton&&u.canvas.currentlyDraggingObject.passedOutOfButton(u,!0)};this.upperButtonMouseDown=function(e){o=new todoLink(u.canvas);o.lowerItem=u;o.startButton="upper";u.canvas.currentlyDraggingObject=u};this.lowerButtonMouseDown=function(e){o=new todoLink(u.canvas);o.upperItem=u;o.startButton="lower";u.canvas.currentlyDraggingObject=u};this.passedOverButton=function(e){if(o.startButton=="upper"){if(u.done&&!e.done)return;for(var t=0;t<u.upperLinks.length;t++)if(u.upperLinks[t].upperItem==e)return;o.upperItem=e}else if(o.startButton=="lower"){if(!u.done&&e.done)return;for(var t=0;t<u.lowerLinks.length;t++)if(u.lowerLinks[t].lowerItem==e)return;o.lowerItem=e}};this.passedOutOfButton=function(e){o.startButton=="upper"?o.upperItem=null:o.startButton=="lower"&&(o.lowerItem=null)};this.generalMouseUp=function(e){if(!o)return;if(o.upperItem&&o.lowerItem){o.upperItem.addLowerLink(o);o.lowerItem.addUpperLink(o);NetworkManager.todoItemDependencyLinked(o.upperItem.id,o.lowerItem.id);o=null}else{o.onDelete();o=null}u.canvas.currentlyDraggingObject==u&&(u.canvas.currentlyDraggingObject=null)};this.generalMouseMoved=function(e){o&&o.updateLine()};this.cleanupEditable=makeEditable(this,this.textBox,this.onDelete,this.onEditStateChange);this.cleanupDraggable=makeDraggable(this,this.div);this.upperButton.addEventListener("mouseover",this.upperButtonMouseOver);this.upperButton.addEventListener("mouseout",this.upperButtonMouseOut);this.upperButton.addEventListener("mousedown",this.upperButtonMouseDown);this.lowerButton.addEventListener("mouseover",this.lowerButtonMouseOver);this.lowerButton.addEventListener("mouseout",this.lowerButtonMouseOut);this.lowerButton.addEventListener("mousedown",this.lowerButtonMouseDown);this.div.addEventListener("mouseover",this.mainMouseOver);this.div.addEventListener("mouseout",this.mainMouseOut);window.addEventListener("mouseup",this.generalMouseUp);window.addEventListener("mousemove",this.generalMouseMoved)}function todoLink(e){this.canvas=e;var t=50;this.line=new bezierLine(e,e.mouseX,e.mouseY,e.mouseX,e.mouseY,t);this.upperItem;this.lowerItem;this.startButton;this.deleteButton=document.createElement("button");this.deleteButton.className="linkDelete";this.deleteButton.style.display="none";this.deleteButton.style.position="absolute";e.canvasElm.parentNode.appendChild(this.deleteButton);var n=this;this.updateLine=function(){var e=0,t=0;if(n.upperItem){n.line.start.x=n.upperItem.pos.x+(n.upperItem.div.offsetWidth-t)/2;n.line.start.y=n.upperItem.pos.y+n.upperItem.div.offsetHeight-t}else{n.line.start.x=n.canvas.mouseX;n.line.start.y=n.canvas.mouseY}if(n.lowerItem){n.line.end.x=n.lowerItem.pos.x+(n.lowerItem.div.offsetWidth-t)/2;n.line.end.y=n.lowerItem.pos.y-t}else{n.line.end.x=n.canvas.mouseX;n.line.end.y=n.canvas.mouseY}if(n.upperItem&&n.lowerItem){n.deleteButton.style.display="";var r=n.upperItem.pos.x+(n.upperItem.div.offsetWidth-t)/2;r+=n.lowerItem.pos.x+(n.lowerItem.div.offsetWidth-t)/2;r/=2;r-=n.deleteButton.offsetWidth/2;var i=n.upperItem.pos.y+n.upperItem.div.offsetHeight-t;i+=n.lowerItem.pos.y;i/=2;i-=n.deleteButton.offsetHeight/2;n.deleteButton.style.left=r+"px";n.deleteButton.style.top=i+"px"}else n.deleteButton.style.display="none"};this.onDelete=function(t){n.line.onDelete();if(n.upperItem&&n.lowerItem){n.upperItem.removeLowerLink(n);n.lowerItem.removeUpperLink(n);t&&NetworkManager.todoItemDependencyRemoved(n.upperItem.id,n.lowerItem.id)}e.draw();n.deleteButton.parentNode&&n.deleteButton.parentNode.removeChild(n.deleteButton)};this.deleteButton.onclick=function(){n.onDelete(!0)}};